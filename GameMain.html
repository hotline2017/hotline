<!doctype html>
<html>
<head>
<meta charset="utf8">
<title>Socket.IO CharMove</title>
<style>
  body {
    margin  : 0;
  }

  .wrapper{
    width   : 100%;
    height  : 100%;
    position: fixed;
  }
</style>
</head>
<body>

<div class="wrapper">
<canvas id="canvas"></canvas>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/player.js"></script>
<script src="/js/MathExtension.js"></script>
<script src="/js/MyInput.js"></script>
<script>

    var socket = io();
    var bg = new Image();
    bg.src = "image/GameBG.png";

    //ゲームの残り時間
    var gametimer = 180 * 60;

    //参加しているプレイヤーを入れておく連想配列
    var players = {};
    //ローカルで使うプレイヤーのId兼ハッシュキー(文字)
    var currentid = null;

    var input = new MyInput();
    window.onkeydown   = function(e)
    {
        input.KeyStates[e.keyCode] = true;
    }

    window.onkeyup     = function(e)
    {
        input.KeyStates[e.keyCode] = false;
    }

    window.onmousemove = function(e)
    {
        input.mouse_x = e.clientX;
        input.mouse_y = e.clientY;
    }

    window.onmousedown = function(e)
    {
        input.clickStatus = true;
    }

    window.onmouseup   = function(e)
    {
        input.clickStatus = false;
    }

    window.onload = function(){

        //画面枠を最大サイズにする（初期状態の大きさなので実行中に大きさ変えるとバグる）
        var w = $('.wrapper').width();
        var h = $('.wrapper').height();
        $('#canvas').attr('width' , w);
        $('#canvas').attr('height', h);

        input.init();
	}

    //終了時
    window.onbeforeunload = function(){
        socket.emit('gameend',currentid);
    }


    var renderer_canvas = function(){

        var canvas = $("#canvas").get(0);
        var ctx = canvas.getContext('2d');
        ctx.drawImage(bg, 0, 0, $('#canvas').width(), $('#canvas').height());

        //ローカルプレイヤーのみ更新
        if(players[currentid])players[currentid].update(input);
        //全ての連想配列の描画処理を実行
        for (var key in players) {
            players[key].draw(ctx);
        }

        //後に更新
        input.rateUpdate();
        //他のサーバーにキャラが移動することを送信
        if(players[currentid])socket.emit('sendplayerupdate', players[currentid]);
        gametimer--;
        socket.emit('gametimerdata', gametimer);
        if(gametimer <= 0)
        {
            socket.emit('gamefinish');
        }

        txtDisplay(ctx,""+gametimer,100,100,24,'FFFFFF');
        progress_timer = setTimeout("renderer_canvas()", 16);
    }

    function txtDisplay(ctx, txt, tx, ty, tsize, textcolor){
				em = 0;
				var tmp_data = [];
				tmp_data = txt.split("<BR>");
				ctx.font = tsize + "px 'ＭＳ Ｐゴシック'";
				ctx.fillStyle = textcolor;

				for(i=0;i<tmp_data.length;i++){
					ctx.fillText(tmp_data[i], tx, (ty + (tsize) + ((tsize + em) * i)));
				}
	}

$(function () {
    var name   = null;
	//-----------------------
	// ユーザー名の入力を求める
	//-----------------------
	do{
		name = prompt("あなたの名前を「半角英数字」で入力してください");
		if(! name.match(/^[a-zA-Z0-9]{1,}$/)){
			name = null;
		}
	} while(name===null);

    //名前を入力したら入場宣言
    socket.emit('playerjoin');

    renderer_canvas();

    //---------------終了-------------------------------------------------


    //if(!players[playerdata.id]) そのIDを持つものは存在するか？の意味

    //プレイヤーが入ってきた時の処理
    socket.on('playerjoin', function(numid){
        console.log("join");
        //新しいプレイヤーを生成する
        players[numid] = new Player(numid, "image/player.png", MathExtension.random(0,$('#canvas').width()), MathExtension.random(0,$('#canvas').height()), 30);
        if(currentid == null) currentid = numid;
        //最新のユーザーでない場合自分の場所を最新のユーザーに伝えて生成させる
        else socket.emit('gameinit',players[currentid]);
	});

    //他のユーザーを出現生成させる
    socket.on('gameinit', function(playerdata)
    {
        if(!players[playerdata.id])
        {
             players[playerdata.id] = new Player(playerdata.id, "image/player.png", playerdata.pos_x , playerdata.pos_y, playerdata.angle);
        }
	})

    //ゲーム終了が通告されたら
    socket.on('gamefinish', function(inittime)
    {
        gametimer =inittime;
	})

    //だれかがゲームから抜けた
    socket.on('gameend', function(exitid)
    {
        delete players[exitid];
	})

    //ゲーム時間のアップデート
	socket.on('gametimerdata', function(timerdata)
    {
        gametimer = timerdata;
	});

    //プレイヤーのアップデート
	socket.on('sendplayerupdate', function(playerdata){
        if(players[playerdata.id])
        {
            players[playerdata.id].receiveMove(playerdata.id,playerdata.pos_x,playerdata.pos_y);
            players[playerdata.id].receiverotate(playerdata.angle);
        }
	});

});
</script>
</body>
</html>