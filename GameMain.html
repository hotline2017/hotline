<!doctype html>
<html>
<head>
<meta charset="utf8">
<title>Socket.IO CharMove</title>
<style>
  body {
    background-image: url("./image/GameBG.png");
    margin  : 0;
  }

  .wrapper{
    width   : 100%;
    height  : 100%;
    position: fixed;
  }

  .form
  {
    position: absolute;
    left: 475px;
    top: 400px;
    font-size:  32px;
    text-align: center;
  }
</style>
</head>
<body>
<div class="wrapper">
<canvas id="canvas">
</canvas>
</div>
<form id="input" class="form" onsubmit="return false;">
    名前を入力してください<br>
    <input input type="text" style="width: 500; height: 32px; font-size:  32px;"/>
<form/>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/player.js"></script>
<script src="/js/site.js"></script>
<script src="/js/MathExtension.js"></script>
<script src="/js/MyInput.js"></script>
<script>
    var assetloadnum = 0;
    var assetmaxnum = 2;

    var socket = io();

    var bg;
    var title_img;

    var bg_file = "image/GameBG.png";
    var title_img_file = "image/alien_Title.png";

    var name = null;

    var firstfrag = false;

    //0がタイトル　1ゲームメイン　2リザルト（未定）
    var gamemode = 0;

    //ゲームの残り時間
    var gametimer = 180 * 60;

    //参加しているプレイヤーを入れておく連想配列
    var players = {};
    //ローカルで使うプレイヤーのId兼ハッシュキー(文字)
    var currentid = null;

    var input = new MyInput();

    var audioElem = new Audio();

    var sites   = new Array();

    window.onkeydown   = function(e)
    {
        input.KeyStates[e.keyCode] = true;
    }

    window.onkeyup     = function(e)
    {
        input.KeyStates[e.keyCode] = false;
    }

    window.onmousemove = function(e)
    {
        input.mouse_x = e.clientX;
        input.mouse_y = e.clientY;
    }

    window.onmousedown = function(e)
    {
        input.clickStatus = true;
    }

    window.onmouseup   = function(e)
    {
        input.clickStatus = false;
    }

    window.onload = function () {

        //画面枠を最大サイズにする（初期状態の大きさなので実行中に大きさ変えるとバグる）
        var w = $('.wrapper').width();
        var h = $('.wrapper').height();
        $('#canvas').attr('width', w);
        $('#canvas').attr('height', h);

        input.init();

        bg = new Image();
        bg.src = bg_file;
        bg.onload = function () {
            assetloadnum++;
        }

        title_img = new Image();
        title_img.src = title_img_file;
        title_img.onload = function () {
            assetloadnum++;
        }

        audioElem.src = "./sound/TitleBGM.mp3";
        audioElem.play();

        renderer_canvas();
    }

    //終了時
    window.addEventListener('beforeunload', function (e) {
        e.returnValue = "終了しますか？";
        socket.emit('gameend', currentid);
    });


    var renderer_canvas = function () {

        if (assetloadnum == assetmaxnum);
        {
            var canvas = $("#canvas").get(0);
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0,0, ctx.canvas.width, ctx.canvas.height);

            switch (gamemode) {
                case 0: TitleUpdate(ctx); break;
                case 1: MainUpdate(ctx); break;
            }
        }

        progress_timer = setTimeout("renderer_canvas()", 16);
    }

    function TitleUpdate(ctx) {

        var posx = ($('#canvas').width () / 2) - 370;
        var posy = ($('#canvas').height() / 2) - 100;
        ctx.drawImage(title_img,0,0,745,121,posx,posy,745,121);

        //エンターキー
        if(input.isKeydown(13))
        {
            var node = document.getElementById('input');
	        node.parentNode.removeChild(node);

            //if(name = null)
            audioElem.src = "./sound/PlayBGM.mp3";
            audioElem.play();

            socket.emit('playerjoin');
            gamemode = 1;
        }
        name =null;
        // if (!firstfrag) {
        //     setTimeout(function () {
        //         do{
        //             name = prompt("あなたの名前を「半角英数字」で入力してください");
        //             if (!name.match(/^[a-zA-Z0-9]{1,}$/)) {
        //                 name = null;
        //             }
        //         } while (name === null)
        //         socket.emit('playerjoin');
        //         gamemode = 1; // Gameメインへ
        //         //audioElem.src = "sound/PlayBGM.mp3";
        //         //audioElem.play();
        //     }, 100);
        //     firstfrag = true;
        // }
    }

    function MainUpdate(ctx)
    {
        //ローカルプレイヤーのみ更新
        if (players[currentid]) 
        {
            players[currentid].update(input);
            if((gametimer % 5) == 0)
            {
                socket.emit('sendalivestate', currentid, players[currentid].is_alive);
            }
        }

        //他のサーバーにキャラが移動することを送信
        if (players[currentid]) socket.emit('sendplayerupdate', players[currentid]);
        gametimer--;
        socket.emit('gametimerdata', gametimer);
        {
            var posx = ($('#canvas').width() / 2) - 96;
            var posy = 16;
            txtDisplay(ctx, "TIME:" + gametimer, posx, posy, 34, 'FFFFFF');
        }

        for(var key1 in players)
        {
            for(var key2 in players)
            {
                players[key1].collision(players[key2]);
            }
        }

        for(var key in sites)
        {
            sites[key].draw(ctx);
        }

        //全ての連想配列の描画処理を実行
        for (var key in players) {
            players[key].draw(ctx);
        }
        
        //後に更新
        input.rateUpdate();

        if(gametimer <= 0)
        {
            socket.emit("gamefinish");
        }
    }

    function txtDisplay(ctx, txt, tx, ty, tsize, textcolor){
				em = 0;
				var tmp_data = [];
				tmp_data = txt.split("<BR>");
				ctx.font = tsize + "px 'ＭＳ Ｐゴシック'";
				ctx.fillStyle = textcolor;

				for(i=0;i<tmp_data.length;i++){
					ctx.fillText(tmp_data[i], tx, (ty + (tsize) + ((tsize + em) * i)));
				}
	}

    $(function () {

        //---------------終了-------------------------------------------------


        //if(!players[playerdata.id]) そのIDを持つものは存在するか？の意味

        //プレイヤーが入ってきた時の処理
        socket.on('playerjoin', function (numid) {
            if (gamemode == 0) return;
            console.log("join");
            //新しいプレイヤーを生成する
            players[numid] = new Player(numid, "image/player", MathExtension.random(0, $('#canvas').width()), MathExtension.random(0, $('#canvas').height()), 30);
            if (currentid == null) currentid = numid;
                //最新のユーザーでない場合自分の場所を最新のユーザーに伝えて生成させる
            else socket.emit('gameinit', players[currentid]);
        });

        //他のユーザーを出現生成させる
        socket.on('gameinit', function (playerdata) {
            if (!players[playerdata.id]) {
                players[playerdata.id] = new Player(playerdata.id, "image/player", playerdata.pos_x, playerdata.pos_y, playerdata.angle);
            }
        })

        //ゲーム終了が通告されたら
        socket.on('gamefinish', function (inittime) {
            gametimer = inittime;
        })

        //だれかがゲームから抜けた
        socket.on('gameend', function (exitid) {
            delete players[exitid];
        })

        //ゲーム時間のアップデート
        socket.on('gametimerdata', function (timerdata) {
            gametimer = timerdata;
        });

        //プレイヤーのアップデート
        socket.on('sendplayerupdate', function (playerdata) {
            if(playerdata.id == currentid) { return; }

            if (players[playerdata.id]) {
                players[playerdata.id].serverUpdate();
                players[playerdata.id].receiveMove(playerdata.id, playerdata.pos_x, playerdata.pos_y);
                players[playerdata.id].receiveRotate(playerdata.angle);
            }
        });

        socket.on('bulletupdate', function(playerdata)
        {
            if(playerdata.id == currentid) { return; }
            if(players[playerdata.id])
            {
                players[playerdata.id].bulletUpdate();
            }
        });

        socket.on('bulletdeath', function(id, bulletIndex)
        {
            if(id == currentid) { return; }

            if(players[id])
            {
                players[id].bulletErase(bulletIndex);
            }
        });
        
        //だれかが弾を撃った
        socket.on('sendplayershot', function(playerdata)
        {
            if(playerdata.id == currentid) { return; }

            if(players[playerdata.id])
            {
                players[playerdata.id].receiveShot(playerdata.pos_x, playerdata.pos_y, playerdata.angle);
            }
        });

        socket.on('sendplayerdeath', function(playerdata)
        {
            if(players[playerdata.id])
            {
                sites.push(new Site(playerdata.id, playerdata.pos_x, playerdata.pos_y));
                players[playerdata.id].dead();
            }
        });

        socket.on('sendplayerrespawn', function(playerdata)
        {
            if(playerdata.id == currentid) { return; }

            if(players[playerdata.id])
            {
                players[playerdata.id].respawn();
            }
        });

        socket.on('sendalivestate', function(id, is_alive)
        {
            if(id == currentid) { return; }

            if(players[id])
            {
                players[id].is_alive = is_alive;
            }
        });
    });
</script>
</body>
</html>
