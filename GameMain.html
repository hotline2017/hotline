<!doctype html>
<html>
<head>
<meta charset="utf8">
<title>Socket.IO CharMove</title>
<style>
  body {
    margin  : 0;
  }

  .wrapper{
    width   : 100%;
    height  : 100%;
    position: fixed;
  }
</style>
</head>
<body>

<div class="wrapper">
<canvas id="canvas"></canvas>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/player.js"></script>
<script src="/js/MyInput.js"></script>
<script>

    var socket = io();
    var bg = new Image();
    bg.src = "image/GameBG.png";
    var players = {};

    var currentid = null;

    var input = new MyInput();
    window.onkeydown   = function(e)
    {
        input.KeyStates[e.keyCode] = true;
    }

    window.onkeyup     = function(e)
    {
        input.KeyStates[e.keyCode] = false;
    }

    window.onmousemove = function(e)
    {
        input.mouse_x = e.clientX;
        input.mouse_y = e.clientY;
    };

    window.onload = function(){
                var w = $('.wrapper').width();
                var h = $('.wrapper').height();
                $('#canvas').attr('width' , w);
                $('#canvas').attr('height', h);

                //players[0] = new Player(0, "image/player.png", 100, 100, 30);
                //players[1]  = new Player(1, "image/player.png", 400, 100, 30);
                //players[2]  = new Player(2, "image/player.png", 100, 400, 30);
                //players[3]  = new Player(3, "image/player.png", 400, 400, 30);

                input.init();
			}


    var renderer_canvas = function(){

        var canvas = $("#canvas").get(0);
        var ctx = canvas.getContext('2d');
        ctx.drawImage(bg, 0, 0, $('#canvas').width(), $('#canvas').height());

        if(players[currentid])players[currentid].update(input);
        for (var key in players) {
            players[key].draw(ctx);
        }

        //後に更新
        input.rateUpdate();
        //他のサーバーにキャラが移動することを送信
        if(players[currentid])socket.emit('movechar', {id:players[currentid].id, posx:players[currentid].pos_x,posy:players[currentid].pos_y});

        progress_timer = setTimeout("renderer_canvas()", 16);
    }

$(function () {
    var name   = null;
	//-----------------------
	// ユーザー名の入力を求める
	//-----------------------
	do{
		name = prompt("あなたの名前を「半角英数字」で入力してください");
		if(! name.match(/^[a-zA-Z0-9]{1,}$/)){
			name = null;
		}
	} while(name===null);

    //名前を入力したら入場宣言
    socket.emit('playerjoin');

    renderer_canvas();

    //---------------終了-------------------------------------------------

    socket.on('playerjoin', function(num){
        console.log("join");
        players[''+num] = new Player(num, "image/player.png", num * 100, num * 100, 30);
        if(currentid == null) currentid = ''+num;
        //else socket.emit('gameinit',currentid);
        else socket.emit('gameinit',players[currentid]);
	});

    socket.on('gameinit', function(playerdata)
    {
        if(!players[''+playerdata.id])
        {
             players[''+playerdata.id] = new Player(playerdata.id, "image/player.png", playerdata.pos_x , playerdata.pos_y, 30);
        }
	})

	socket.on('movechar', function(data){
        if(players[data.id]) players[data.id].receiveMove(data.id,data.posx,data.posy);
	});

});
</script>
</body>
</html>